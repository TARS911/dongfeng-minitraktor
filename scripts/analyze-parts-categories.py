#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—á–∞—Å—Ç–µ–π Agrodom - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
"""
import json
import re
from collections import defaultdict
from urllib.parse import unquote

INPUT_FILE = "parsed_data/agrodom/products-clean.json"

def extract_brand(name, url):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –±—Ä–µ–Ω–¥ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ URL"""
    name_lower = name.lower()
    url_lower = unquote(url).lower() if url else ''

    brands = {
        'DongFeng': ['dongfeng', '–¥–æ–Ω–≥—Ñ–µ–Ω–≥', '–¥—Ñ-', 'df-'],
        'MasterYard': ['masteryard', '–º–∞—Å—Ç–µ—Ä—è—Ä–¥'],
        'Jinma': ['jinma', '–¥–∂–∏–Ω–º–∞', 'jm-'],
        '–£—Ä–∞–ª–µ—Ü': ['—É—Ä–∞–ª–µ—Ü', 'uralets'],
        'Xingtai': ['xingtai', '—Å–∏–Ω—Ç–∞–π'],
        'Foton': ['foton', '—Ñ–æ—Ç–æ–Ω'],
        'Swatt': ['swatt', '—Å–≤–∞—Ç—Ç'],
        'Shifeng': ['shifeng', '—à–∏—Ñ–µ–Ω–≥'],
        '–ú–∞—Ö—ñndra': ['mahindra', '–º–∞—Ö–∏–Ω–¥—Ä–∞'],
        'YTO': ['yto'],
        'Scout': ['scout', '—Å–∫–∞—É—Ç'],
        '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ': ['—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω']
    }

    for brand, keywords in brands.items():
        for keyword in keywords:
            if keyword in name_lower or keyword in url_lower:
                return brand

    return '–î—Ä—É–≥–∏–µ'

def extract_category(url):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ URL"""
    if not url:
        return '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'

    url_decoded = unquote(url).lower()

    # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    categories = {
        '–ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞': ['–≥–∏–¥—Ä–∞–≤–ª–∏–∫–∞', '–≥–∏–¥—Ä–æ'],
        '–¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è': ['—Ç—Ä–∞–Ω—Å–º–∏—Å—Å–∏', '–∫–æ—Ä–æ–±–∫–∞-–ø–µ—Ä–µ–¥–∞—á', '—Å—Ü–µ–ø–ª–µ–Ω–∏–µ', '–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª'],
        '–î–≤–∏–≥–∞—Ç–µ–ª—å': ['–¥–≤–∏–≥–∞—Ç–µ–ª', '–¥–∏–∑–µ–ª'],
        '–≠–ª–µ–∫—Ç—Ä–æ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ': ['—ç–ª–µ–∫—Ç—Ä–æ', '—Å—Ç–∞—Ä—Ç–µ—Ä', '–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä'],
        '–ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ': ['–Ω–∞–≤–µ—Å–Ω–æ–µ-–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', '–ø–ª—É–≥', '–∫—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä', '–∫–æ—Å–∏–ª–∫', '–±–æ—Ä–æ–Ω', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª–µ–∫–æ–ø–∞–ª–∫', '–ø–æ—á–≤–æ—Ñ—Ä–µ–∑', '–≥—Ä–∞–±–ª–∏', '—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä', '—â–µ—Ç–∫', '–ø—Ä–∏—Ü–µ–ø', '–ø—Ä–µ—Å—Å'],
        '–ü–µ—Ä–µ–¥–Ω–∏–π –º–æ—Å—Ç': ['–ø–µ—Ä–µ–¥–Ω–∏–π-–º–æ—Å—Ç'],
        '–†—É–ª–µ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': ['—Ä—É–ª–µ–≤'],
        '–¢–æ—Ä–º–æ–∑–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞': ['—Ç–æ—Ä–º–æ–∑'],
        '–ö–∞—Ä–¥–∞–Ω–Ω—ã–µ –≤–∞–ª—ã': ['–∫–∞—Ä–¥–∞–Ω–Ω'],
        '–ö–æ–ª–µ—Å–∞ –∏ —à–∏–Ω—ã': ['–∫–æ–ª—ë—Å–∞', '–∫–æ–ª–µ—Å–∞', '—à–∏–Ω—ã'],
        '–§–∏–ª—å—Ç—Ä—ã': ['—Ñ–∏–ª—å—Ç—Ä'],
        '–ö–∞–±–∏–Ω–∞': ['–∫–∞–±–∏–Ω', '—Å—Ç–µ–∫–ª'],
        '–¢–æ–ø–ª–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞': ['—Ç–æ–ø–ª–∏–≤–Ω'],
        '–ö–∞–ø–æ—Ç –∏ –∫—Ä—ã–ª—å—è': ['–∫–∞–ø–æ—Ç', '–∫—Ä—ã–ª—å'],
        '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è': ['—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ-–∏–∑–¥–µ–ª–∏—è', '—Å–∞–ª—å–Ω–∏–∫', '–ø–æ–¥—à–∏–ø–Ω–∏–∫', '–ø–∞–ª–µ—Ü', '–∫–æ–ª—å—Ü', '–º–µ—Ç–∏–∑', '—Ä–µ–º–Ω'],
        '–°–∏–¥–µ–Ω—å—è': ['—Å–∏–¥–µ–Ω—å—è', '–∫—Ä–µ—Å–ª–∞'],
        '–†–í–î': ['—Ä–≤–¥']
    }

    for category, keywords in categories.items():
        for keyword in keywords:
            if keyword in url_decoded:
                return category

    return '–ü—Ä–æ—á–µ–µ'

def extract_subcategory(url, name):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é"""
    if not url:
        return None

    url_decoded = unquote(url).lower()
    name_lower = name.lower()

    # –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    subcategories = {
        # –ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞
        '–ì–∏–¥—Ä–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª–∏': ['–≥–∏–¥—Ä–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª'],
        '–ì–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä—ã': ['–≥–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä'],
        '–ì–∏–¥—Ä–æ–Ω–∞—Å–æ—Å—ã': ['–≥–∏–¥—Ä–æ–Ω–∞—Å–æ—Å', '–Ω–∞—Å–æ—Å'],
        '–ì–∏–¥—Ä–æ–±–∞–∫–∏': ['–≥–∏–¥—Ä–æ–±–∞–∫'],

        # –¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è
        '–°—Ü–µ–ø–ª–µ–Ω–∏–µ': ['—Å—Ü–µ–ø–ª–µ–Ω–∏–µ'],
        '–ö–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á': ['–∫–æ—Ä–æ–±–∫–∞-–ø–µ—Ä–µ–¥–∞—á'],
        '–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª': ['–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª'],
        '–†–∞–∑–¥–∞—Ç–æ—á–Ω—ã–π –≤–∞–ª': ['—Ä–∞–∑–¥–∞—Ç–æ—á–Ω'],

        # –î–≤–∏–≥–∞—Ç–µ–ª—å
        '–î–∏–∑–µ–ª—å R195': ['r195', 'r180', 'km130', 'km138'],
        '–î–∏–∑–µ–ª—å S195': ['s195', 's1100', 's1110'],
        '–î–∏–∑–µ–ª—å TY290': ['ty290', 'ty295'],
        '–î–∏–∑–µ–ª—å ZN390': ['zn390', 'zn490'],
        '–î–∏–∑–µ–ª—å 4L22BT': ['4l22bt'],
        '–î–∏–∑–µ–ª—å JD295': ['jd295', 'ty2100'],
        '–î–∏–∑–µ–ª—å YD385T': ['yd385t'],

        # –≠–ª–µ–∫—Ç—Ä–∏–∫–∞
        '–°—Ç–∞—Ä—Ç–µ—Ä—ã': ['—Å—Ç–∞—Ä—Ç–µ—Ä'],
        '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã': ['–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä'],

        # –ù–∞–≤–µ—Å–Ω–æ–µ
        '–ü–ª—É–≥–∏': ['–ø–ª—É–≥'],
        '–ü–æ—á–≤–æ—Ñ—Ä–µ–∑—ã': ['–ø–æ—á–≤–æ—Ñ—Ä–µ–∑'],
        '–ö–æ—Å–∏–ª–∫–∏': ['–∫–æ—Å–∏–ª–∫'],
        '–ö—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä—ã': ['–∫—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä'],
        '–ë–æ—Ä–æ–Ω—ã': ['–±–æ—Ä–æ–Ω'],
        '–ö–∞—Ä—Ç–æ—Ñ–µ–ª–µ–∫–æ–ø–∞–ª–∫–∏': ['–∫–∞—Ä—Ç–æ—Ñ–µ–ª–µ–∫–æ–ø–∞–ª–∫'],
        '–ì—Ä–∞–±–ª–∏': ['–≥—Ä–∞–±–ª–∏'],
        '–ü—Ä–µ—Å—Å–ø–æ–¥–±–æ—Ä—â–∏–∫–∏': ['–ø—Ä–µ—Å—Å'],

        # –ö–∞—Ä–¥–∞–Ω—ã
        '–ö–∞—Ä–¥–∞–Ω–Ω—ã–µ –≤–∞–ª—ã': ['–∫–∞—Ä–¥–∞–Ω–Ω-–≤–∞–ª'],
        '–ö—Ä–µ—Å—Ç–æ–≤–∏–Ω—ã': ['–∫—Ä–µ—Å—Ç–æ–≤–∏–Ω'],
        '–ú—É—Ñ—Ç—ã': ['–º—É—Ñ—Ç'],

        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è
        '–ü–æ–¥—à–∏–ø–Ω–∏–∫–∏': ['–ø–æ–¥—à–∏–ø–Ω–∏–∫'],
        '–°–∞–ª—å–Ω–∏–∫–∏': ['—Å–∞–ª—å–Ω–∏–∫'],
        '–ö–æ–ª—å—Ü–∞': ['–∫–æ–ª—å—Ü'],
    }

    for subcat, keywords in subcategories.items():
        for keyword in keywords:
            if keyword in url_decoded or keyword in name_lower:
                return subcat

    return None

def main():
    print("\n" + "="*70)
    print("–ê–ù–ê–õ–ò–ó –ó–ê–ü–ß–ê–°–¢–ï–ô AGRODOM - –ë–†–ï–ù–î–´ –ò –ö–ê–¢–ï–ì–û–†–ò–ò")
    print("="*70 + "\n")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    with open(INPUT_FILE, 'r', encoding='utf-8') as f:
        products = json.load(f)

    print(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(products)} —Ç–æ–≤–∞—Ä–æ–≤\n")

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –±—Ä–µ–Ω–¥—ã
    brands_count = defaultdict(int)
    categories_count = defaultdict(int)
    subcategories_count = defaultdict(int)
    brand_category_matrix = defaultdict(lambda: defaultdict(int))

    for product in products:
        name = product.get('name', '')
        url = product.get('link', '')

        brand = extract_brand(name, url)
        category = extract_category(url)
        subcategory = extract_subcategory(url, name)

        brands_count[brand] += 1
        categories_count[category] += 1
        if subcategory:
            subcategories_count[subcategory] += 1
        brand_category_matrix[brand][category] += 1

    # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –±—Ä–µ–Ω–¥–∞–º
    print("üìä –ë–†–ï–ù–î–´ (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏):")
    print("-" * 70)
    for brand, count in sorted(brands_count.items(), key=lambda x: -x[1]):
        percent = (count / len(products)) * 100
        print(f"  {brand:20s} : {count:4d} —Ç–æ–≤–∞—Ä–æ–≤ ({percent:5.1f}%)")

    # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    print(f"\nüì¶ –ö–ê–¢–ï–ì–û–†–ò–ò:")
    print("-" * 70)
    for category, count in sorted(categories_count.items(), key=lambda x: -x[1]):
        percent = (count / len(products)) * 100
        print(f"  {category:30s} : {count:4d} —Ç–æ–≤–∞—Ä–æ–≤ ({percent:5.1f}%)")

    # –í—ã–≤–æ–¥–∏–º —Ç–æ–ø-20 –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
    print(f"\nüîß –¢–û–ü-20 –ü–û–î–ö–ê–¢–ï–ì–û–†–ò–ô:")
    print("-" * 70)
    top_subcats = sorted(subcategories_count.items(), key=lambda x: -x[1])[:20]
    for subcat, count in top_subcats:
        percent = (count / len(products)) * 100
        print(f"  {subcat:30s} : {count:4d} —Ç–æ–≤–∞—Ä–æ–≤ ({percent:5.1f}%)")

    # –ú–∞—Ç—Ä–∏—Ü–∞ –±—Ä–µ–Ω–¥-–∫–∞—Ç–µ–≥–æ—Ä–∏—è
    print(f"\nüéØ –ú–ê–¢–†–ò–¶–ê: –ë–†–ï–ù–î √ó –ö–ê–¢–ï–ì–û–†–ò–Ø (—Ç–æ–ø-5 –±—Ä–µ–Ω–¥–æ–≤)")
    print("-" * 70)
    top_brands = sorted(brands_count.items(), key=lambda x: -x[1])[:5]
    for brand, _ in top_brands:
        print(f"\n{brand}:")
        brand_cats = sorted(brand_category_matrix[brand].items(), key=lambda x: -x[1])[:5]
        for cat, count in brand_cats:
            print(f"  - {cat:30s} : {count:3d} —Ç–æ–≤–∞—Ä–æ–≤")

    print("\n" + "="*70)
    print("–ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–Å–ù")
    print("="*70 + "\n")

if __name__ == "__main__":
    main()
