#!/usr/bin/env python3
"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Ç–∏–ø—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è
"""

import os
import re
from supabase import Client, create_client
from multiprocessing import Pool, cpu_count

url = os.environ.get("SUPABASE_URL") or os.environ.get("NEXT_PUBLIC_SUPABASE_URL")
key = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∏—Ö –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
CATEGORY_PATTERNS = {
    # –î–≤–∏–≥–∞—Ç–µ–ª–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    "parts-engines": [
        r"–¥–≤–∏–≥–∞—Ç–µ–ª", r"–¥–∏–∑–µ–ª", r"–±–ª–æ–∫ —Ü–∏–ª–∏–Ω–¥—Ä", r"–≥–æ–ª–æ–≤–∫–∞.*—Ü–∏–ª–∏–Ω–¥—Ä", r"–≥–±—Ü",
        r"–∫–æ–ª–µ–Ω–≤–∞–ª", r"–∫–æ–ª–µ–Ω—á–∞—Ç—ã–π –≤–∞–ª", r"–ø–æ—Ä—à–Ω", r"—à–∞—Ç—É–Ω", r"–≤–∫–ª–∞–¥—ã—à",
        r"–∫–ª–∞–ø–∞–Ω.*(–≤–ø—É—Å–∫|–≤—ã–ø—É—Å–∫)", r"—Ä–∞—Å–ø—Ä–µ–¥–≤–∞–ª", r"—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å–Ω.*–≤–∞–ª",
        r"–≥–∏–ª—å–∑–∞ —Ü–∏–ª–∏–Ω–¥—Ä–∞", r"–ø–∞–ª–µ—Ü –ø–æ—Ä—à–Ω–µ–≤", r"–≤—Ç—É–ª–∫–∞ —à–∞—Ç—É–Ω–∞", r"—Å–µ–¥–ª–æ.*–∫–ª–∞–ø–∞–Ω"
    ],

    # –ì–∏–¥—Ä–∞–≤–ª–∏–∫–∞
    "parts-hydraulics": [
        r"–≥–∏–¥—Ä–æ", r"–±—Ä—Å", r"–±—ã—Å—Ç—Ä–æ—Ä–∞–∑—ä–µ–º", r"–≥–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä", r"–≥–∏–¥—Ä–æ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª",
        r"—Ä–≤–¥", r"—Ä—É–∫–∞–≤.*–≥–∏–¥—Ä–∞–≤–ª", r"—à—Ç—É—Ü–µ—Ä", r"–¥–∂–æ–π—Å—Ç–∏–∫", r"–≥–∏–¥—Ä–æ–±–∞–∫",
        r"–≥–∏–¥—Ä–æ—Å–∏—Å—Ç–µ–º–∞", r"–≥–∏–¥—Ä–∞–≤–ª–∏–∫"
    ],

    # –§–∏–ª—å—Ç—Ä—ã
    "parts-filters": [
        r"—Ñ–∏–ª—å—Ç—Ä", r"–º–∞—Å–ª—è.*—Ñ–∏–ª—å—Ç—Ä", r"—Ç–æ–ø–ª–∏–≤.*—Ñ–∏–ª—å—Ç—Ä", r"–≤–æ–∑–¥—É—à.*—Ñ–∏–ª—å—Ç—Ä",
        r"–≥–∏–¥—Ä–∞–≤–ª.*—Ñ–∏–ª—å—Ç—Ä"
    ],

    # –¢–æ–ø–ª–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
    "parts-fuel-system": [
        r"—Ç–Ω–≤–¥", r"–Ω–∞—Å–æ—Å.*—Ç–æ–ø–ª–∏–≤", r"—Ñ–æ—Ä—Å—É–Ω–∫", r"—Ä–∞—Å–ø—ã–ª–∏—Ç–µ–ª", r"—Ç–æ–ø–ª–∏–≤–Ω",
        r"–∏–Ω–∂–µ–∫—Ç–æ—Ä", r"–±–∞–∫.*—Ç–æ–ø–ª–∏–≤"
    ],

    # –°–∏—Å—Ç–µ–º–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è
    "parts-cooling": [
        r"—Ä–∞–¥–∏–∞—Ç–æ—Ä", r"–≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä.*–æ—Ö–ª–∞–∂–¥", r"–∫—Ä—ã–ª—å—á–∞—Ç–∫–∞.*–æ—Ö–ª–∞–∂–¥",
        r"—Ç–µ—Ä–º–æ—Å—Ç–∞—Ç", r"–ø–æ–º–ø–∞", r"–Ω–∞—Å–æ—Å.*–≤–æ–¥—è–Ω–æ–π", r"–æ—Ö–ª–∞–∂–¥"
    ],

    # –≠–ª–µ–∫—Ç—Ä–∏–∫–∞
    "parts-electrical": [
        r"–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä", r"—Å—Ç–∞—Ä—Ç–µ—Ä", r"–∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä", r"–ø—Ä–æ–≤–æ–¥–∫", r"—Ä–µ–ª–µ",
        r"–ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª", r"–ª–∞–º–ø–∞", r"—Ñ–∞—Ä–∞", r"—ç–ª–µ–∫—Ç—Ä–æ", r"–∫–Ω–æ–ø–∫–∞.*–≤—ã–∫–ª—é—á–∞—Ç–µ–ª",
        r"–∫–æ–Ω—Ü–µ–≤.*–≤—ã–∫–ª—é—á–∞—Ç–µ–ª"
    ],

    # –¢—Ä–∞–Ω—Å–º–∏—Å—Å–∏—è
    "parts-transmission": [
        r"–∫–ø–ø", r"–∫–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á", r"—Å—Ü–µ–ø–ª–µ–Ω", r"–¥–∏—Å–∫.*—Å—Ü–µ–ø–ª–µ–Ω",
        r"–∫–æ—Ä–∑–∏–Ω–∞.*—Å—Ü–µ–ø–ª–µ–Ω", r"–≤—ã–∂–∏–º–Ω.*–ø–æ–¥—à–∏–ø–Ω–∏–∫", r"—Ç—Ä–∞–Ω—Å–º–∏—Å—Å"
    ],

    # –ö–∞—Ä–¥–∞–Ω–Ω—ã–µ –≤–∞–ª—ã
    "parts-driveshaft": [
        r"–≤–∞–ª.*–∫–∞—Ä–¥–∞–Ω", r"–∫–∞—Ä–¥–∞–Ω–Ω.*–≤–∞–ª", r"–∫—Ä–µ—Å—Ç–æ–≤–∏–Ω.*–∫–∞—Ä–¥–∞–Ω",
        r"—à–ª–∏—Ü.*–≤–∞–ª", r"–ø—Ä–∏–≤–æ–¥–Ω.*–≤–∞–ª"
    ],

    # –¢–æ—Ä–º–æ–∑–∞
    "parts-brakes": [
        r"—Ç–æ—Ä–º–æ–∑", r"–∫–æ–ª–æ–¥–∫.*—Ç–æ—Ä–º–æ–∑", r"–¥–∏—Å–∫.*—Ç–æ—Ä–º–æ–∑", r"–±–∞—Ä–∞–±–∞–Ω.*—Ç–æ—Ä–º–æ–∑",
        r"—Ü–∏–ª–∏–Ω–¥—Ä.*—Ç–æ—Ä–º–æ–∑", r"—Ç–æ—Ä–º–æ–∑–Ω"
    ],

    # –†—É–ª–µ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    "parts-steering": [
        r"—Ä—É–ª–µ–≤", r"—Ä—É–ª—å", r"–≥–∏–¥—Ä–æ—É—Å–∏–ª–∏—Ç–µ–ª.*—Ä—É–ª", r"—Ç—è–≥–∞.*—Ä—É–ª–µ–≤",
        r"–Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫.*—Ä—É–ª–µ–≤", r"—Ä–µ–π–∫–∞.*—Ä—É–ª–µ–≤"
    ],

    # –•–æ–¥–æ–≤–∞—è —á–∞—Å—Ç—å
    "parts-chassis": [
        r"–ø–æ–¥—à–∏–ø–Ω–∏–∫", r"—Å—Ç—É–ø–∏—Ü–∞", r"–ø–æ–ª—É–æ—Å—å", r"–º–æ—Å—Ç", r"—Ä–µ–¥—É–∫—Ç–æ—Ä.*–º–æ—Å—Ç",
        r"–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª", r"—à–∫–≤–æ—Ä–Ω", r"—Ä–µ—Å—Å–æ—Ä", r"–∞–º–æ—Ä—Ç–∏–∑–∞—Ç–æ—Ä"
    ],

    # –ö–æ–ª–µ—Å–∞ –∏ —à–∏–Ω—ã
    "parts-wheels-tires": [
        r"–∫–æ–ª–µ—Å[–æ–∞]", r"—à–∏–Ω–∞", r"–ø–æ–∫—Ä—ã—à–∫", r"–∫–∞–º–µ—Ä–∞.*–∫–æ–ª–µ—Å", r"–¥–∏—Å–∫.*–∫–æ–ª–µ—Å",
        r"–æ–±–æ–¥"
    ],

    # –†–µ–º–Ω–∏
    "parts-belts": [
        r"—Ä–µ–º–µ–Ω—å", r"—Ä–µ–º–µ–Ω.*–ø—Ä–∏–≤–æ–¥–Ω", r"—Ä–µ–º–µ–Ω.*–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä"
    ],

    # –ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - –ö–æ—Å–∏–ª–∫–∏
    "parts-attachments-mowers": [
        r"–∫–æ—Å–∏–ª–∫", r"–Ω–æ–∂.*–∫–æ—Å–∏–ª–∫", r"–º–æ–ª–æ—Ç–æ–∫.*–∫–æ—Å–∏–ª–∫", r"–±–∞—Ä–∞–±–∞–Ω.*–∫–æ—Å–∏–ª–∫",
        r"—Ä–æ—Ç–æ—Ä.*–∫–æ—Å–∏–ª–∫", r"—Å–µ–≥–º–µ–Ω—Ç.*–∫–æ—Å–∏–ª–∫", r"–ø–æ–ª–æ—Ç–Ω.*–∫–æ—Å–∏–ª–∫",
        r"—à–∞—Ç—É–Ω.*–∫–æ—Å–∏–ª–∫", r"–≥–∞–∑–æ–Ω–æ–∫–æ—Å–∏–ª–∫", r"—Ä–æ—Ç–æ—Ä–Ω.*–∫–æ—Å–∏–ª–∫"
    ],

    # –ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - –ü–æ—á–≤–æ—Ñ—Ä–µ–∑—ã
    "parts-attachments-tillers": [
        r"–ø–æ—á–≤–æ—Ñ—Ä–µ–∑", r"—Ñ—Ä–µ–∑[–∞—ã]", r"1gqn", r"1gqe", r"–Ω–æ–∂.*–ø–æ—á–≤–æ—Ñ—Ä–µ–∑",
        r"–∑—É–±.*–ø–æ—á–≤–æ—Ñ—Ä–µ–∑", r"—Ä–µ–¥—É–∫—Ç–æ—Ä.*–ø–æ—á–≤–æ—Ñ—Ä–µ–∑", r"—à–µ—Å—Ç–µ—Ä–Ω.*–ø–æ—á–≤–æ—Ñ—Ä–µ–∑",
        r"–≤–∞–ª.*–ø–æ–¥ –Ω–æ–∂–∏", r"–∫—Ä–µ–ø–ª–µ–Ω–∏–µ.*–Ω–æ–∂–∞", r"—â–∏—Ç–æ–∫.*–ø–æ—á–≤–æ—Ñ—Ä–µ–∑"
    ],

    # –ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - –ü—Ä–µ—Å—Å-–ø–æ–¥–±–æ—Ä—â–∏–∫–∏
    "parts-attachments-balers": [
        r"–ø—Ä–µ—Å—Å.–ø–æ–¥–±–æ—Ä—â–∏–∫", r"yk0850", r"yk0870", r"yk0890", r"yk1070",
        r"rxyk", r"rxfk", r"–∑–≤–µ–∑–¥–æ—á–∫.*–ø—Ä–µ—Å—Å", r"—Ü–µ–ø—å.*–ø—Ä–µ—Å—Å",
        r"–≤—è–∑–∞–ª—å–Ω.*–∞–ø–ø–∞—Ä–∞—Ç", r"—à–ø–∞–≥–∞—Ç", r"–ø—Ä—É–∂–∏–Ω.*–ø—Ä–µ—Å—Å", r"–±–∞—Ä–∞–±–∞–Ω.*–ø—Ä–µ—Å—Å",
        r"–≥—Ä–∞–±–ª–∏–Ω.*–ø—Ä–µ—Å—Å", r"–≤–∞–ª.*–ø—Ä–µ—Å—Å.–ø–æ–¥–±–æ—Ä—â–∏–∫"
    ],

    # –ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - –ü–ª—É–≥–∏
    "parts-attachments-plows": [
        r"–ø–ª—É–≥", r"1l-220", r"1l-320", r"2l-220", r"–ª–µ–º–µ—Ö", r"–∫–æ—Ä–ø—É—Å.*–ø–ª—É–≥",
        r"—Å—Ç–æ–π–∫–∞.*–ø–ª—É–≥", r"–æ—Ç–≤–∞–ª.*–ø–ª—É–≥"
    ],

    # –ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - –ë–æ—Ä–æ–Ω—ã
    "parts-attachments-harrows": [
        r"–±–æ—Ä–æ–Ω", r"1bqx", r"1bjx", r"–¥–∏—Å–∫.*–±–æ—Ä–æ–Ω", r"–≤–∞–ª.*–±–æ—Ä–æ–Ω",
        r"—Ç–∞—Ä–µ–ª–∫.*–±–æ—Ä–æ–Ω", r"—Å–∫—Ä–µ–±–æ–∫.*–±–æ—Ä–æ–Ω"
    ],

    # –ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - –ö—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä—ã
    "parts-attachments-cultivators": [
        r"–∫—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä", r"–æ–∫—É—á–Ω–∏–∫", r"–ª–∞–ø–∞.*–∫—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä", r"—Å—Ç—Ä–µ–ª–∞.*–∫—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä",
        r"—Ä—ã—Ö–ª–∏—Ç–µ–ª"
    ],

    # –ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - –ö–∞—Ä—Ç–æ—Ñ–µ–ª–µ–∫–æ–ø–∞–ª–∫–∏
    "parts-attachments-potato": [
        r"–∫–∞—Ä—Ç–æ—Ñ–µ–ª–µ–∫–æ–ø–∞–ª", r"–∫–∞—Ä—Ç–æ—Ñ–µ–ª–µ—Å–∞–∂–∞–ª", r"–∫–∫-540", r"–∫–∫-1-540",
        r"–Ω26.*–∫–∞—Ä—Ç–æ—Ñ–µ–ª", r"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.*–∫–∞—Ä—Ç–æ—Ñ–µ–ª"
    ],

    # –ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ - –ì—Ä–∞–±–ª–∏-–≤–æ—Ä–æ—à–∏–ª–∫–∏
    "parts-attachments-rakes": [
        r"–≥—Ä–∞–±–ª", r"–≤–æ—Ä–æ—à–∏–ª", r"—Å–ø–∏—Ü–∞.*–≥—Ä–∞–±–ª", r"–∑—É–±.*–≥—Ä–∞–±–ª",
        r"—Ç–∞—Ä–µ–ª–∫.*–≥—Ä–∞–±–ª", r"–¥–∏—Å–∫.*–≥—Ä–∞–±–ª"
    ],

    # –ü—Ä–æ—á–µ–µ –Ω–∞–≤–µ—Å–Ω–æ–µ
    "parts-attachments": [
        r"–Ω–∞–≤–µ—Å–Ω", r"–∫—É–Ω", r"–ø–æ–≥—Ä—É–∑—á–∏–∫", r"–∫–æ–≤—à", r"—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",
        r"–æ—Ç–≤–∞–ª", r"—â–µ—Ç–∫–∞.*–∫–æ–º–º—É–Ω–∞–ª—å–Ω", r"—Å–µ—è–ª–∫", r"—Ä–∞–∑–±—Ä–∞—Å—ã–≤–∞—Ç–µ–ª"
    ]
}

def categorize_product(name: str, current_category: str = "") -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞ –ø–æ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—é"""
    if not name:
        return current_category or "parts-minitractors"

    name_lower = name.lower()

    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    for category, patterns in CATEGORY_PATTERNS.items():
        for pattern in patterns:
            if re.search(pattern, name_lower):
                return category

    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∏–ª–∏ –æ–±—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    if current_category and current_category.startswith("parts-"):
        return current_category

    return "parts-minitractors"

def process_batch(batch_num: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω –±–∞—Ç—á —Ç–æ–≤–∞—Ä–æ–≤"""
    supabase = create_client(url, key)

    offset = batch_num * 500
    result = supabase.table("products") \
        .select("id, name, specifications, category_id") \
        .range(offset, offset + 499) \
        .execute()

    if not result.data:
        return {"batch": batch_num, "updated": 0, "skipped": 0}

    updated = 0
    skipped = 0

    for product in result.data:
        name = product.get("name", "")
        specs = product.get("specifications") or {}
        current_cat = specs.get("category", "")

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        new_category = categorize_product(name, current_cat)

        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
        if new_category != current_cat:
            specs["category"] = new_category

            try:
                supabase.table("products") \
                    .update({"specifications": specs}) \
                    .eq("id", product["id"]) \
                    .execute()
                updated += 1
            except Exception as e:
                skipped += 1
        else:
            skipped += 1

    return {"batch": batch_num, "updated": updated, "skipped": skipped}

if __name__ == "__main__":
    print("=" * 80)
    print("ü§ñ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ö–ê–¢–ï–ì–û–†–ò–ó–ê–¶–ò–Ø –¢–û–í–ê–†–û–í")
    print("=" * 80 + "\n")

    # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
    supabase = create_client(url, key)
    count_result = supabase.table("products").select("id", count="exact").execute()
    total_products = count_result.count

    print(f"üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {total_products}")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç—á–µ–π
    batch_size = 500
    num_batches = (total_products // batch_size) + 1

    print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç—á–µ–π: {num_batches}")
    print(f"üíª –ò—Å–ø–æ–ª—å–∑—É–µ–º {min(12, cpu_count())} –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤\n")

    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    with Pool(processes=min(12, cpu_count())) as pool:
        results = pool.map(process_batch, range(num_batches))

    # –ü–æ–¥—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    total_updated = sum(r["updated"] for r in results)
    total_skipped = sum(r["skipped"] for r in results)

    print("\n" + "=" * 80)
    print("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
    print("=" * 80)
    print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ:  {total_updated:>6} —Ç–æ–≤–∞—Ä–æ–≤")
    print(f"‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ:  {total_skipped:>6} —Ç–æ–≤–∞—Ä–æ–≤")
    print("=" * 80)

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    print("\nüîç –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:\n")

    category_stats = {}
    offset = 0

    while offset < total_products:
        result = supabase.table("products") \
            .select("specifications") \
            .range(offset, offset + 999) \
            .execute()

        if not result.data:
            break

        for p in result.data:
            specs = p.get("specifications") or {}
            cat = specs.get("category", "NO_CATEGORY")
            category_stats[cat] = category_stats.get(cat, 0) + 1

        offset += 1000

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
    for cat, count in sorted(category_stats.items(), key=lambda x: -x[1]):
        print(f"{cat:45} {count:>6}")

    print("\n" + "=" * 80)
