#!/usr/bin/env python3
"""
–£–õ–£–ß–®–ï–ù–ù–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–ü–ß–ê–°–¢–ï–ô –ü–û –ë–†–ï–ù–î–ê–ú –ò –¢–ò–ü–ê–ú
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
"""

import os
import re
from collections import defaultdict

from supabase import Client, create_client

url = os.environ.get("SUPABASE_URL") or os.environ.get("NEXT_PUBLIC_SUPABASE_URL")
key = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")

if not url or not key:
    print("‚ùå –û–®–ò–ë–ö–ê: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
    print("   export NEXT_PUBLIC_SUPABASE_URL='...'")
    print("   export SUPABASE_SERVICE_ROLE_KEY='...'")
    exit(1)

supabase: Client = create_client(url, key)

# ============================================================================
# –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–ê–¢–¢–ï–†–ù–´ –ë–†–ï–ù–î–û–í (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
# ============================================================================
BRAND_PATTERNS = {
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –°–∞–º—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    "perkins": ["perkins", "–ø–µ—Ä–∫–∏–Ω—Å"],  # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ
    "dongfeng-parts": [
        "dongfeng",
        "–¥–æ–Ω–≥—Ñ–µ–Ω–≥",
        "–¥—É–Ω—Ñ–µ–Ω–≥",
        "dong feng",
        "df-244",
        "df-404",
        "df 244",
        "df 404",
        "df244",
        "df404",
    ],
    "km-engines": ["–∫–º385", "–∫–º496", "ll380", "ll385", "km385", "km496", "yd385"],
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ë—Ä–µ–Ω–¥—ã —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
    "uralets": ["—É—Ä–∞–ª–µ—Ü", "uralets"],
    "jinma": ["–¥–∂–∏–Ω–º–∞", "jinma", "jin ma"],
    "xingtai": ["—Å–∏–Ω—Ç–∞–π", "xingtai", "xing tai", "—Å–∏–Ω—Ç–∞–π-504"],
    "foton": ["—Ñ–æ—Ç–æ–Ω", "foton", "lovol"],
    "rusich": ["—Ä—É—Å–∏—á", "rusich"],
    "shifeng": ["—à–∏—Ñ–µ–Ω–≥", "shifeng", "shi feng"],
    "catmann": ["–∫—ç—Ç–º–∞–Ω–Ω", "catmann", "–∫–µ—Ç–º–∞–Ω–Ω"],
    "chuvashpiller": ["—á—É–≤–∞—à–ø–∏–ª–ª–µ—Ä", "chuvashpiller"],
    "bulat": ["–±—É–ª–∞—Ç", "bulat"],
    "yto": ["yto"],
    "wirax": ["wirax", "–≤–∏—Ä–∞–∫—Å"],
    "dlh": ["dlh"],
    "rustrak": ["—Ä—É—Å—Ç—Ä–∞–∫", "rustrak"],
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ú–¢–ó –∏ –ë–µ–ª–∞—Ä—É—Å (–≤–º–µ—Å—Ç–µ)
    "mtz": ["–º—Ç–∑", "mtz", "–±–µ–ª–∞—Ä—É—Å", "belarus"],
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –ë—Ä–µ–Ω–¥—ã —Å –º–æ–¥–µ–ª—è–º–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –°–¢–†–û–ì–û)
    "scout": ["—Å–∫–∞—É—Ç —Ç-", "scout t-", "—Å–∫–∞—É—Ç-—Ç", "scout-t"],  # –¢–æ–ª—å–∫–æ —Å –º–æ–¥–µ–ª—å—é
    "kentavr": ["–∫–µ–Ω—Ç–∞–≤—Ä —Ç-", "kentavr t-", "—Ç-224", "t-224"],  # –¢–æ–ª—å–∫–æ —Å –º–æ–¥–µ–ª—å—é
    "fayter": ["—Ñ–∞–π—Ç–µ—Ä —Ç-", "fayter t-"],  # –¢–æ–ª—å–∫–æ —Å –º–æ–¥–µ–ª—å—é
    "neva": ["–Ω–µ–≤–∞", "neva", "–º–±-", "–º–± "],
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5: T-series (–æ–±—â–µ–µ –¥–ª—è –≤—Å–µ—Ö –¢-40, –¢-25, –¢-16)
    "t-series": ["—Ç-40", "—Ç-25", "—Ç-16", "t-40", "t-25", "t-16"],
}

# ============================================================================
# –ü–ê–¢–¢–ï–†–ù–´ –¢–ò–ü–û–í –ó–ê–ü–ß–ê–°–¢–ï–ô (–æ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫ –æ–±—â–∏–º)
# ============================================================================
TYPE_PATTERNS = {
    # –°–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ
    "diesel-engines": [
        "–¥–≤–∏–≥–∞—Ç–µ–ª—å",
        "–¥–≤–∏–≥–∞—Ç–µ–ª—è",
        "–º–æ—Ç–æ—Ä",
        "–ø–æ—Ä—à–µ–Ω—å",
        "–ø–æ—Ä—à–Ω–µ–≤—ã–µ",
        "–ø–æ—Ä—à–Ω—è",
        "—Ü–∏–ª–∏–Ω–¥—Ä",
        "–≥–∏–ª—å–∑–∞",
        "–≥–±—Ü",
        "–≥–æ–ª–æ–≤–∫–∞ –±–ª–æ–∫–∞",
        "–∫–æ–ª–µ–Ω–≤–∞–ª",
        "–∫–æ–ª–µ–Ω—á–∞—Ç—ã–π –≤–∞–ª",
        "—Ä–∞—Å–ø—Ä–µ–¥–≤–∞–ª",
        "–±–ª–æ–∫ —Ü–∏–ª–∏–Ω–¥—Ä–æ–≤",
        "–∫–∞—Ä—Ç–µ—Ä",
        "–º–∞—Ö–æ–≤–∏–∫",
        "—à–∞—Ç—É–Ω",
    ],
    "starters-generators": ["—Å—Ç–∞—Ä—Ç–µ—Ä", "–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä"],
    "filters": ["—Ñ–∏–ª—å—Ç—Ä"],
    "driveshafts": ["–∫–∞—Ä–¥–∞–Ω", "–∫–∞—Ä–¥–∞–Ω–Ω—ã–π –≤–∞–ª", "–∫–∞—Ä–¥–∞–Ω–Ω—ã–π"],
    "hydraulics": [
        "–≥–∏–¥—Ä–∞–≤–ª–∏–∫",
        "–≥–∏–¥—Ä–æ—Ü–∏–ª–∏–Ω–¥—Ä",
        "–≥–∏–¥—Ä–æ–Ω–∞—Å–æ—Å",
        "–Ω—à-",
        "–Ω—à ",
        "–≥—É—Ä",
        "—Ä—É–ª–µ–≤–æ–π —Ü–∏–ª–∏–Ω–¥—Ä",
    ],
    "seats": ["—Å–∏–¥–µ–Ω—å–µ", "—Å–∏–¥–µ–Ω–∏–µ", "–∫—Ä–µ—Å–ª–æ"],
    "spare-parts-kit": ["–∑–∏–ø", "—Ä–µ–º–∫–æ–º–ø–ª–µ–∫—Ç", "—Ä–µ–º–æ–Ω—Ç–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç", "—Ä–µ–º.–∫–æ–º–ø–ª–µ–∫—Ç"],
    "equipment-parts": [
        "–∫–∞—Ä—Ç–æ—Ñ–µ–ª–µ–∫–æ–ø–∞–ª–∫–∞",
        "–∫–æ—Å–∏–ª–∫–∞",
        "–æ–∫—É—á–Ω–∏–∫",
        "–ø–ª—É–≥",
        "–±–æ—Ä–æ–Ω–∞",
        "—Ñ—Ä–µ–∑–∞",
        "—Å–Ω–µ–≥–æ—É–±–æ—Ä—â–∏–∫",
        "–ø—Ä–∏—Ü–µ–ø",
        "–ø–æ–≥—Ä—É–∑—á–∏–∫",
        "–ø—Ä–µ—Å—Å-–ø–æ–¥–±–æ—Ä—â–∏–∫",
        "–∫—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä",
    ],
    "wheels-tires": [
        "–∫–æ–ª–µ—Å–æ",
        "–∫–æ–ª—ë—Å",
        "–¥–∏—Å–∫ –∫–æ–ª–µ—Å–Ω",
        "—à–∏–Ω–∞",
        "—Ä–µ–∑–∏–Ω–∞",
        "–ø–æ–∫—Ä—ã—à–∫–∞",
        "–≥—Ä—É–∑ –∫–æ–ª–µ—Å–Ω",
        "–≥—Ä—É–Ω—Ç–æ–∑–∞—Ü–µ–ø",
    ],
    "standard-parts": [
        "–±–æ–ª—Ç",
        "–≥–∞–π–∫–∞",
        "—à–ø–∏–ª—å–∫–∞",
        "–≤–∏–Ω—Ç",
        "–ø—Ä–æ–∫–ª–∞–¥–∫–∞",
        "—Å–∞–ª—å–Ω–∏–∫",
        "–∫–æ–ª—å—Ü–æ —É–ø–ª–æ—Ç–Ω",
        "–∫–æ–ª—å—Ü–æ —Å—Ç–æ–ø–æ—Ä–Ω",
        "–º–∞–Ω–∂–µ—Ç–∞",
        "—à–∞–π–±–∞",
        "—à–ø–ª–∏–Ω—Ç",
        "–ø–∞–ª–µ—Ü —Å—Ç–æ–ø–æ—Ä–Ω",
        "—à—Ç–∏—Ñ—Ç",
        "–ø—Ä—É–∂–∏–Ω–∞",
    ],
    "tractor-parts": [
        "—Ä–µ–¥—É–∫—Ç–æ—Ä",
        "–∫–æ—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á",
        "–∫–ø–ø",
        "—Å—Ü–µ–ø–ª–µ–Ω–∏–µ",
        "–∫–æ—Ä–∑–∏–Ω–∞",
        "–¥–∏—Å–∫ —Å—Ü–µ–ø–ª–µ–Ω–∏—è",
        "–≤–∞–ª",
        "–≤–æ–º",
        "–ø—Ä–∏–≤–æ–¥",
        "–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª",
        "—Ç–æ—Ä–º–æ–∑",
        "—Ç–æ—Ä–º–æ–∑–Ω",
    ],
    # –ë–æ–ª–µ–µ –æ–±—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    "universal-parts": ["—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω", "–∫–æ–º–ø–ª–µ–∫—Ç –ø—Ä–æ–∫–ª–∞–¥–æ–∫", "–Ω–∞–±–æ—Ä"],
    "other-parts": [
        "–ø—Ä–æ—á–∏–µ",
        "–ø—Ä–æ—á–µ–µ",
        "–Ω–∞–≤–µ—Å–Ω–æ–µ",
        "–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
        "–∫—Ä–µ–ø–ª–µ–Ω–∏–µ",
        "–∫—Ä–æ–Ω—à—Ç–µ–π–Ω",
        "–∞–¥–∞–ø—Ç–µ—Ä",
        "–∫–∞–±–∏–Ω–∞",
        "–∫—Ä—ã–ª–æ",
        "–∑–µ—Ä–∫–∞–ª–æ",
        "–∫–æ–ª–ø–∞–∫",
        "–∫–æ–≤—à",
        "–±–æ—Ä—Ç",
        "—Ñ–∞—Ä–∫–æ–ø",
        "–±–∞–º–ø–µ—Ä",
        "—Ñ–∞—Ä–∞",
        "—Å—Ç–µ–∫–ª–æ",
        "—Ä—É–ª–µ–≤–æ–µ",
        "–ø–µ–¥–∞–ª—å",
    ],
}


def detect_brand(product_name: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±—Ä–µ–Ω–¥ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
    name_lower = product_name.lower()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—Ä–µ–Ω–¥—ã –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    for brand_key, patterns in BRAND_PATTERNS.items():
        for pattern in patterns:
            if pattern.lower() in name_lower:
                return brand_key

    return "universal"


def detect_type(product_name: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∑–∞–ø—á–∞—Å—Ç–∏ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"""
    name_lower = product_name.lower()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã –≤ –ø–æ—Ä—è–¥–∫–µ –æ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫ –æ–±—â–∏–º
    for type_key, patterns in TYPE_PATTERNS.items():
        for pattern in patterns:
            if pattern.lower() in name_lower:
                return type_key

    return "other-parts"


def main():
    print("\n" + "=" * 80)
    print("üöÄ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–ü–ß–ê–°–¢–ï–ô –ü–û –ë–†–ï–ù–î–ê–ú –ò –¢–ò–ü–ê–ú")
    print("=" * 80 + "\n")

    # ========================================================================
    # –®–ê–ì 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –ë–î
    # ========================================================================
    print("üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –ë–î...")
    all_categories = supabase.table("categories").select("id, name, slug").execute()
    categories_map = {cat["slug"]: cat["id"] for cat in all_categories.data}
    print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(categories_map)} –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n")

    # ========================================================================
    # –®–ê–ì 2: –ù–∞—Ö–æ–¥–∏–º ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ó–∞–ø—á–∞—Å—Ç–∏"
    # ========================================================================
    print("üîç –ü–æ–∏—Å–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '–ó–∞–ø—á–∞—Å—Ç–∏'...")
    parts_category = None
    for cat in all_categories.data:
        if cat["slug"] == "parts" or "–∑–∞–ø—á–∞—Å—Ç–∏" in cat["name"].lower():
            if "–¥–ª—è" not in cat["name"].lower():  # –ù–µ –±–µ—Ä—ë–º "–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è Dongfeng"
                parts_category = cat
                break

    if not parts_category:
        print("‚ùå –û–®–ò–ë–ö–ê: –ö–∞—Ç–µ–≥–æ—Ä–∏—è '–ó–∞–ø—á–∞—Å—Ç–∏' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:")
        for cat in all_categories.data[:10]:
            print(f"  - {cat['name']} (slug: {cat['slug']})")
        exit(1)

    parts_cat_id = parts_category["id"]
    print(f"‚úÖ –ù–∞–π–¥–µ–Ω–∞: [{parts_cat_id}] {parts_category['name']}\n")

    # ========================================================================
    # –®–ê–ì 3: –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ó–∞–ø—á–∞—Å—Ç–∏"
    # ========================================================================
    print("üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '–ó–∞–ø—á–∞—Å—Ç–∏'...")
    all_parts = []
    offset = 0

    while True:
        batch = (
            supabase.table("products")
            .select("id, name, category_id")
            .eq("category_id", parts_cat_id)
            .range(offset, offset + 999)
            .execute()
        )

        if not batch.data:
            break

        all_parts.extend(batch.data)
        offset += 1000
        print(f"  –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(all_parts)} —Ç–æ–≤–∞—Ä–æ–≤...")

    print(f"\n‚úÖ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏: {len(all_parts)}\n")
    print("=" * 80)

    if len(all_parts) == 0:
        print("\n‚úÖ –í—Å–µ —Ç–æ–≤–∞—Ä—ã —É–∂–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã!")
        exit(0)

    # ========================================================================
    # –®–ê–ì 4: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã
    # ========================================================================
    print("\nüîç –ê–Ω–∞–ª–∏–∑ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤...\n")

    migration_plan = []
    stats = defaultdict(int)
    not_found_categories = defaultdict(list)
    brand_distribution = defaultdict(int)
    type_distribution = defaultdict(int)

    for product in all_parts:
        brand = detect_brand(product["name"])
        part_type = detect_type(product["name"])

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        brand_distribution[brand] += 1
        type_distribution[part_type] += 1

        # –§–æ—Ä–º–∏—Ä—É–µ–º slug –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: brand-type
        category_slug = f"{brand}-{part_type}"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –ë–î
        new_cat_id = categories_map.get(category_slug)

        if new_cat_id:
            migration_plan.append(
                {
                    "product_id": product["id"],
                    "product_name": product["name"],
                    "old_category": parts_cat_id,
                    "new_category": new_cat_id,
                    "category_slug": category_slug,
                    "brand": brand,
                    "type": part_type,
                }
            )
            stats[category_slug] += 1
        else:
            # –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î
            not_found_categories[category_slug].append(product["name"][:70])

    # ========================================================================
    # –®–ê–ì 5: –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    # ========================================================================
    print(f"‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: {len(all_parts)} —Ç–æ–≤–∞—Ä–æ–≤")
    print(f"‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏: {len(migration_plan)} —Ç–æ–≤–∞—Ä–æ–≤")
    print(f"‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {len(not_found_categories)} —à—Ç.\n")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–µ–Ω–¥–∞–º
    print("üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –±—Ä–µ–Ω–¥–∞–º:")
    for brand, count in sorted(brand_distribution.items(), key=lambda x: -x[1])[:15]:
        print(f"  {brand:25} ‚Üí {count:4} —Ç–æ–≤–∞—Ä–æ–≤")

    print("\nüìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º:")
    for ptype, count in sorted(type_distribution.items(), key=lambda x: -x[1])[:15]:
        print(f"  {ptype:25} ‚Üí {count:4} —Ç–æ–≤–∞—Ä–æ–≤")

    # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
    if not_found_categories:
        print("\n" + "=" * 80)
        print("\n‚ö†Ô∏è  –ö–ê–¢–ï–ì–û–†–ò–ò –ù–ï –ù–ê–ô–î–ï–ù–´ –í –ë–î:\n")
        for cat_slug, examples in sorted(not_found_categories.items()):
            print(f"  ‚ùå {cat_slug}: {len(examples)} —Ç–æ–≤–∞—Ä–æ–≤")
            print(f"     –ü—Ä–∏–º–µ—Ä—ã: {examples[:2]}")
            print()
        print(
            "üí° –°–æ–≤–µ—Ç: –°–æ–∑–¥–∞–π—Ç–µ —ç—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ '–ó–∞–ø—á–∞—Å—Ç–∏'"
        )

    # –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏
    print("\n" + "=" * 80)
    print("\nüìã –ü–õ–ê–ù –ú–ò–ì–†–ê–¶–ò–ò (—Ç–æ–ø 20 –∫–∞—Ç–µ–≥–æ—Ä–∏–π):\n")

    for category_slug, count in sorted(stats.items(), key=lambda x: -x[1])[:20]:
        cat_id = categories_map[category_slug]
        print(f"  ‚úÖ {category_slug:40} ‚Üí {count:4} —Ç–æ–≤–∞—Ä–æ–≤ (ID: {cat_id})")

    print(f"\n\nüìä –ò–¢–û–ì–û:")
    print(f"  ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {len(stats)}")
    print(f"  ‚Ä¢ –¢–æ–≤–∞—Ä–æ–≤ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏: {len(migration_plan)}")
    print(f"  ‚Ä¢ –û—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ '–ó–∞–ø—á–∞—Å—Ç–∏': {len(all_parts) - len(migration_plan)}")

    # ========================================================================
    # –®–ê–ì 6: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
    # ========================================================================
    print("\n" + "=" * 80)
    print("\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑–º–µ–Ω–∏—Ç category_id —É —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î!")
    response = input("\nüöÄ –ù–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é? (yes/no): ")

    if response.lower() != "yes":
        print("\n‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
        exit(0)

    # ========================================================================
    # –®–ê–ì 7: –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é
    # ========================================================================
    print("\nüöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é...")
    print("=" * 80 + "\n")

    success_count = 0
    error_count = 0
    errors = []

    for i, item in enumerate(migration_plan, 1):
        try:
            supabase.table("products").update({"category_id": item["new_category"]}).eq(
                "id", item["product_id"]
            ).execute()

            success_count += 1

            if success_count % 50 == 0:
                progress = (i / len(migration_plan)) * 100
                print(f"  ‚è≥ –ü—Ä–æ–≥—Ä–µ—Å—Å: {i}/{len(migration_plan)} ({progress:.1f}%)")

        except Exception as e:
            error_count += 1
            errors.append(
                {
                    "product_id": item["product_id"],
                    "name": item["product_name"][:50],
                    "error": str(e),
                }
            )

    # ========================================================================
    # –®–ê–ì 8: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    # ========================================================================
    print("\n" + "=" * 80)
    print("\n‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!\n")
    print(f"  –£—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ: {success_count}")
    print(f"  –û—à–∏–±–æ–∫: {error_count}")
    print(f"  –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {len(migration_plan)}")

    if errors:
        print("\n‚ùå –û–®–ò–ë–ö–ò:")
        for err in errors[:10]:
            print(f"  ID {err['product_id']}: {err['name']} - {err['error']}")

    print("\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–∞...")
    remaining = (
        supabase.table("products")
        .select("*", count="exact")
        .eq("category_id", parts_cat_id)
        .execute()
    )
    print(f"  –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '–ó–∞–ø—á–∞—Å—Ç–∏': {remaining.count}")

    print("\n" + "=" * 80)
    print(
        "\nüéâ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —Å–∞–π—Ç–µ: https://beltehferm.netlify.app/catalog"
    )
    print("=" * 80 + "\n")


if __name__ == "__main__":
    main()
