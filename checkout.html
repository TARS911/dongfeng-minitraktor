<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - DONGFENG –ú–∏–Ω–∏—Ç—Ä–∞–∫—Ç–æ—Ä–∞</title>
        <meta
            name="description"
            content="–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –º–∏–Ω–∏—Ç—Ä–∞–∫—Ç–æ—Ä–æ–≤ DONGFENG"
        />

        <link rel="stylesheet" href="css/variables.css?v=1761211422" />
        <link rel="stylesheet" href="css/reset.css?v=1761211422" />
        <link rel="stylesheet" href="css/components.css?v=1761211422" />
        <link rel="stylesheet" href="css/effects.css?v=1761211422" />
        <link rel="stylesheet" href="css/main.css?v=1761211422" />
        <link rel="stylesheet" href="css/modal.css?v=1761211422" />
        <link rel="stylesheet" href="css/header-new.css?v=1761211422" />
        <link rel="stylesheet" href="css/catalog-modals.css?v=1761211422" />
        <link rel="stylesheet" href="css/cart.css?v=1761211422" />
        <style>
            .checkout-page {
                padding: var(--space-xl) 0;
                background: #fafafa;
                min-height: 100vh;
            }

            .checkout-content {
                display: grid;
                grid-template-columns: 1fr 400px;
                gap: var(--space-xl);
                margin-top: var(--space-xl);
            }

            .checkout-form {
                background: white;
                padding: var(--space-xl);
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            .form-section {
                margin-bottom: var(--space-xl);
            }

            .form-section:last-child {
                margin-bottom: 0;
            }

            .form-section-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: var(--space-md);
                color: var(--color-text-primary);
                border-bottom: 2px solid #f0f0f0;
                padding-bottom: var(--space-md);
            }

            .form-group {
                margin-bottom: var(--space-md);
            }

            .form-group:last-child {
                margin-bottom: 0;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: 500;
                color: var(--color-text-primary);
            }

            .form-group input,
            .form-group textarea {
                width: 100%;
                padding: 12px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
                font-family: inherit;
                transition: border-color 0.2s;
            }

            .form-group input:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: var(--brand-primary);
                box-shadow: 0 0 0 3px rgba(42, 157, 78, 0.1);
            }

            .form-group textarea {
                resize: vertical;
                min-height: 100px;
            }

            .required::after {
                content: " *";
                color: #e74c3c;
            }

            .checkout-summary {
                background: white;
                padding: var(--space-xl);
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                position: sticky;
                top: var(--space-lg);
            }

            .summary-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: var(--space-lg);
                color: var(--color-text-primary);
            }

            .summary-item {
                display: flex;
                gap: var(--space-md);
                margin-bottom: var(--space-lg);
                padding-bottom: var(--space-lg);
                border-bottom: 1px solid #f0f0f0;
            }

            .summary-item:last-of-type {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }

            .summary-item__image {
                width: 80px;
                height: 80px;
                object-fit: cover;
                border-radius: 8px;
                flex-shrink: 0;
            }

            .summary-item__info {
                flex: 1;
                min-width: 0;
            }

            .summary-item__name {
                font-weight: 500;
                font-size: 14px;
                margin-bottom: 4px;
                color: var(--color-text-primary);
            }

            .summary-item__specs {
                font-size: 12px;
                color: var(--color-text-secondary);
                margin-bottom: 4px;
            }

            .summary-item__qty {
                font-size: 12px;
                color: var(--color-text-secondary);
            }

            .summary-totals {
                padding: var(--space-md) 0;
                border-top: 2px solid #f0f0f0;
                border-bottom: 2px solid #f0f0f0;
                margin: var(--space-lg) 0;
            }

            .summary-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 12px;
                font-size: 14px;
            }

            .summary-row:last-child {
                margin-bottom: 0;
            }

            .summary-row.total {
                font-weight: 600;
                font-size: 16px;
                color: var(--brand-primary);
                margin-top: 12px;
            }

            .checkout-actions {
                display: flex;
                flex-direction: column;
                gap: var(--space-md);
                margin-top: var(--space-lg);
            }

            .btn--submit {
                background: var(--brand-primary);
                color: white;
                border: none;
                padding: 14px 24px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: background 0.2s;
                width: 100%;
            }

            .btn--submit:hover {
                background: #238a3d;
            }

            .btn--submit:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

            .btn--back {
                background: #f0f0f0;
                color: var(--color-text-primary);
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
                text-align: center;
                text-decoration: none;
                display: block;
            }

            .btn--back:hover {
                background: #e0e0e0;
            }

            .error-message {
                background: #fee;
                color: #c33;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: var(--space-md);
                font-size: 14px;
                display: none;
            }

            .success-message {
                background: #efe;
                color: #2a9d4e;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: var(--space-md);
                font-size: 14px;
                display: none;
            }

            .loading {
                display: none;
                text-align: center;
                padding: var(--space-lg);
            }

            .spinner {
                border: 3px solid #f0f0f0;
                border-top: 3px solid var(--brand-primary);
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
                margin: 0 auto var(--space-md);
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            @media (max-width: 768px) {
                .checkout-content {
                    grid-template-columns: 1fr;
                }

                .checkout-summary {
                    position: static;
                }
            }
        </style>
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header__content">
                    <div class="logo">
                        <a href="index.html" style="text-decoration: none; color: #2a9d4e; font-size: 20px; font-weight: 600;">
                            DONGFENG
                        </a>
                    </div>

                    <nav class="nav">
                        <ul class="nav__list">
                            <li>
                                <a href="index.html" class="nav__link"
                                    >–ì–ª–∞–≤–Ω–∞—è</a
                                >
                            </li>
                            <li>
                                <a href="payment.html" class="nav__link"
                                    >–û–ø–ª–∞—Ç–∞</a
                                >
                            </li>
                            <li>
                                <a href="delivery.html" class="nav__link"
                                    >–î–æ—Å—Ç–∞–≤–∫–∞</a
                                >
                            </li>
                            <li>
                                <a href="warranty.html" class="nav__link"
                                    >–ì–∞—Ä–∞–Ω—Ç–∏—è</a
                                >
                            </li>
                            <li>
                                <a href="articles.html" class="nav__link"
                                    >–°—Ç–∞—Ç—å–∏</a
                                >
                            </li>
                            <li>
                                <a href="contacts.html" class="nav__link"
                                    >–ö–æ–Ω—Ç–∞–∫—Ç—ã</a
                                >
                            </li>
                            <li>
                                <a href="media.html" class="nav__link">–ú–µ–¥–∏–∞</a>
                            </li>
                        </ul>
                    </nav>

                    <div class="header__contacts">
                        <a href="tel:+79699995668" class="phone"
                            >+7 (969) 999-56-68</a
                        >
                        <a href="cart.html" class="cart-icon">
                            üõí –ö–æ—Ä–∑–∏–Ω–∞
                            <span class="cart-count" id="cartCount">0</span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Checkout Page -->
        <section class="checkout-page">
            <div class="container">
                <h1 class="section-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>

                <div class="checkout-content">
                    <!-- Checkout Form -->
                    <form id="checkoutForm" class="checkout-form">
                        <div id="errorMessage" class="error-message"></div>
                        <div id="successMessage" class="success-message"></div>

                        <!-- Customer Info -->
                        <div class="form-section">
                            <h2 class="form-section-title">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>

                            <div class="form-group">
                                <label for="customer_name" class="required">–ò–º—è</label>
                                <input
                                    type="text"
                                    id="customer_name"
                                    name="customer_name"
                                    required
                                    minlength="2"
                                    maxlength="100"
                                    placeholder="–í–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è"
                                />
                            </div>

                            <div class="form-group">
                                <label for="customer_phone" class="required">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input
                                    type="tel"
                                    id="customer_phone"
                                    name="customer_phone"
                                    required
                                    placeholder="+7 (999) 999-99-99"
                                />
                            </div>

                            <div class="form-group">
                                <label for="customer_email">Email</label>
                                <input
                                    type="email"
                                    id="customer_email"
                                    name="customer_email"
                                    placeholder="your@email.com"
                                />
                            </div>
                        </div>

                        <!-- Delivery Info -->
                        <div class="form-section">
                            <h2 class="form-section-title">–î–æ—Å—Ç–∞–≤–∫–∞</h2>

                            <div class="form-group">
                                <label for="delivery_city" class="required">–ì–æ—Ä–æ–¥</label>
                                <input
                                    type="text"
                                    id="delivery_city"
                                    name="delivery_city"
                                    required
                                    minlength="2"
                                    maxlength="100"
                                    placeholder="–ú–æ—Å–∫–≤–∞"
                                />
                            </div>

                            <div class="form-group">
                                <label for="delivery_address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                                <input
                                    type="text"
                                    id="delivery_address"
                                    name="delivery_address"
                                    maxlength="500"
                                    placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞"
                                />
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-section">
                            <h2 class="form-section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h2>

                            <div class="form-group">
                                <label for="notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∫ –∑–∞–∫–∞–∑—É</label>
                                <textarea
                                    id="notes"
                                    name="notes"
                                    maxlength="1000"
                                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å, —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –ø—Ä–∏–µ–∑–¥–∞..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="checkout-actions">
                            <button type="submit" class="btn--submit" id="submitBtn">
                                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
                            </button>
                            <a href="cart.html" class="btn--back">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É</a>
                        </div>
                    </form>

                    <!-- Order Summary -->
                    <div class="checkout-summary">
                        <h3 class="summary-title">–í–∞—à –∑–∞–∫–∞–∑</h3>

                        <div id="summaryItems"></div>

                        <div class="summary-totals">
                            <div class="summary-row">
                                <span>–¢–æ–≤–∞—Ä–æ–≤:</span>
                                <span id="summaryItemsCount">0</span>
                            </div>
                            <div class="summary-row total">
                                <span>–ò—Ç–æ–≥–æ:</span>
                                <span id="summaryTotal">0 ‚ÇΩ</span>
                            </div>
                        </div>

                        <p style="font-size: 12px; color: var(--color-text-secondary); text-align: center; margin: var(--space-md) 0;">
                            –î–æ—Å—Ç–∞–≤–∫–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer__content">
                    <div class="footer__column">
                        <h4>–û –∫–æ–º–ø–∞–Ω–∏–∏</h4>
                        <ul>
                            <li><a href="/#about">–û –Ω–∞—Å</a></li>
                            <li><a href="/#delivery">–î–æ—Å—Ç–∞–≤–∫–∞</a></li>
                            <li><a href="/#contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                        </ul>
                    </div>
                    <div class="footer__column">
                        <h4>–ö–∞—Ç–∞–ª–æ–≥</h4>
                        <ul>
                            <li><a href="/#catalog">–ú–∏–Ω–∏—Ç—Ä–∞–∫—Ç–æ—Ä–∞</a></li>
                        </ul>
                    </div>
                    <div class="footer__column">
                        <h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                        <p><a href="tel:+79999999999">+7 (999) 999-99-99</a></p>
                        <p>
                            <a href="mailto:info@dongfeng-minitraktor.ru"
                                >info@dongfeng-minitraktor.ru</a
                            >
                        </p>
                    </div>
                </div>
                <div class="footer__bottom">
                    <p>
                        &copy; 2025 DONGFENG –ú–∏–Ω–∏—Ç—Ä–∞–∫—Ç–æ—Ä–∞. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
                    </p>
                </div>
            </div>
        </footer>

        <script src="js/config.js"></script>
        <script src="js/global-cart.js"></script>
        <script>
            // Initialize page
            document.addEventListener("DOMContentLoaded", () => {
                if (typeof cart === 'undefined' || cart.length === 0) {
                    window.location.href = '/cart.html';
                    return;
                }

                updateCartCounter();
                renderOrderSummary();
                setupFormHandler();
            });

            // Update cart counter in header
            function updateCartCounter() {
                const cartCount = document.getElementById("cartCount");
                if (cartCount && typeof cart !== 'undefined') {
                    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                    cartCount.textContent = totalItems;
                }
            }

            // Render order summary
            function renderOrderSummary() {
                const container = document.getElementById("summaryItems");
                const itemsCountEl = document.getElementById("summaryItemsCount");
                const totalEl = document.getElementById("summaryTotal");

                let totalPrice = 0;
                let totalItems = 0;

                const itemsHTML = cart.map(item => {
                    const subtotal = item.product.price * item.quantity;
                    totalPrice += subtotal;
                    totalItems += item.quantity;

                    return `
                        <div class="summary-item">
                            <img src="${item.product.image_url}" alt="${item.product.name}" class="summary-item__image">
                            <div class="summary-item__info">
                                <div class="summary-item__name">${item.product.name}</div>
                                <div class="summary-item__specs">${item.product.power} –ª.—Å. ‚Ä¢ ${item.product.drive}</div>
                                <div class="summary-item__qty">–ö–æ–ª-–≤–æ: ${item.quantity}</div>
                                <div class="summary-item__qty">${subtotal.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = itemsHTML;
                itemsCountEl.textContent = totalItems;
                totalEl.textContent = totalPrice.toLocaleString('ru-RU') + ' ‚ÇΩ';
            }

            // Setup form handler
            function setupFormHandler() {
                const form = document.getElementById("checkoutForm");
                const submitBtn = document.getElementById("submitBtn");

                form.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    // Validate form
                    if (!form.checkValidity()) {
                        showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
                        return;
                    }

                    // Disable submit button
                    submitBtn.disabled = true;
                    submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

                    try {
                        // Prepare order data
                        const orderData = {
                            customer_name: document.getElementById("customer_name").value,
                            customer_phone: document.getElementById("customer_phone").value,
                            customer_email: document.getElementById("customer_email").value || null,
                            delivery_city: document.getElementById("delivery_city").value,
                            delivery_address: document.getElementById("delivery_address").value || null,
                            notes: document.getElementById("notes").value || null,
                            items: cart.map(item => ({
                                product_id: item.id,
                                quantity: item.quantity
                            }))
                        };

                        // Submit order
                        const response = await fetch(`${window.API_URL}/api/orders`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(orderData)
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Clear cart
                            localStorage.removeItem('cart');

                            // Show success message
                            showSuccess(data.message || "–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");

                            // Redirect to order confirmation
                            setTimeout(() => {
                                if (data.data && data.data.order_number) {
                                    window.location.href = `/order-confirmation.html?number=${data.data.order_number}`;
                                } else {
                                    window.location.href = '/';
                                }
                            }, 2000);
                        } else {
                            showError(data.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞");
                            submitBtn.disabled = false;
                            submitBtn.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑";
                        }
                    } catch (error) {
                        console.error("Checkout error:", error);
                        showError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
                        submitBtn.disabled = false;
                        submitBtn.textContent = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑";
                    }
                });
            }

            // Show error message
            function showError(message) {
                const errorEl = document.getElementById("errorMessage");
                const successEl = document.getElementById("successMessage");
                errorEl.textContent = message;
                errorEl.style.display = "block";
                successEl.style.display = "none";
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // Show success message
            function showSuccess(message) {
                const successEl = document.getElementById("successMessage");
                const errorEl = document.getElementById("errorMessage");
                successEl.textContent = message;
                successEl.style.display = "block";
                errorEl.style.display = "none";
            }
        </script>
    </body>
</html>
