# üìã –û–¢–ß–Å–¢ –û –†–ï–ê–õ–ò–ó–ê–¶–ò–ò –í–°–ï–• –ó–ê–î–ê–ß

**–î–∞—Ç–∞:** 2025-11-11  
**–ü—Ä–æ–µ–∫—Ç:** Dongfeng Minitraktor (–ë–µ–ª–¢–µ—Ö–§–µ—Ä–º–™)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ó–ê–î–ê–ß–ò –í–´–ü–û–õ–ù–ï–ù–´

---

## üéØ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ó–ê–î–ê–ß–ò

### ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

#### 1. –í–∫–ª—é—á—ë–Ω Rate Limiting (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω middleware.ts)
**–§–∞–π–ª:** `frontend/middleware.ts`

**–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ `a2.snapshot` –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–ª–∞ –ø–∞–¥–µ–Ω–∏–µ —Å–±–æ—Ä–∫–∏
- –£–¥–∞–ª—ë–Ω `setInterval` (–Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å Edge Runtime)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –û–±–Ω–æ–≤–ª—ë–Ω `matcher` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å PWA —Ñ–∞–π–ª–∞–º–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ Middleware –∞–∫—Ç–∏–≤–µ–Ω
‚úÖ Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç: 100 req/min (—Å—Ç—Ä–∞–Ω–∏—Ü—ã), 30 req/min (API)
‚úÖ Build –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS/–±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```typescript
const MAX_REQUESTS_PER_WINDOW = 100; // —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const API_MAX_REQUESTS = 30; // API
const RATE_LIMIT_WINDOW = 60 * 1000; // 1 –º–∏–Ω—É—Ç–∞
```

---

#### 2. –î–æ–±–∞–≤–ª–µ–Ω POST /api/categories endpoint
**–§–∞–π–ª—ã:** 
- `frontend/app/api/categories/route.ts` (GET, POST)
- `frontend/app/api/categories/[id]/route.ts` (GET, PUT, DELETE)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

| –ú–µ—Ç–æ–¥ | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|----------|
| GET | `/api/categories` | –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å –ø–æ–∏—Å–∫–æ–º) |
| POST | `/api/categories` | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é |
| GET | `/api/categories/:id` | –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ ID |
| PUT | `/api/categories/:id` | –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é |
| DELETE | `/api/categories/:id` | –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é |

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è slug (—Ç–æ–ª—å–∫–æ lowercase, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ slug
- ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å —Ç–æ–≤–∞—Ä–∞–º–∏
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (`?search=—Ç—Ä–∞–∫—Ç–æ—Ä`)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```bash
curl -X POST http://localhost:3000/api/categories \
  -H "Content-Type: application/json" \
  -d '{
    "name": "–ü—Ä–∏—Ü–µ–ø—ã",
    "slug": "trailers",
    "description": "–ü—Ä–∏—Ü–µ–ø—ã –¥–ª—è –º–∏–Ω–∏—Ç—Ä–∞–∫—Ç–æ—Ä–æ–≤",
    "image_url": "https://..."
  }'
```

---

#### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ equipment
**–§–∞–π–ª—ã:**
- `docs/supabase-schema.sql`
- `docs/migrations/fix-equipment-category.sql`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```sql
-- –ë–´–õ–û:
('–ù–∞–≤–µ—Å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', 'equipment', '–ü–ª—É–≥–∏, –∫—É–ª—å—Ç–∏–≤–∞—Ç–æ—Ä—ã, –∫–æ—Å–∏–ª–∫–∏')

-- –°–¢–ê–õ–û:
('–ö–æ–º–º—É–Ω–∞–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞', 'equipment', '–°–Ω–µ–≥–æ—É–±–æ—Ä—â–∏–∫–∏, –≥–∞–∑–æ–Ω–æ–∫–æ—Å–∏–ª–∫–∏, –ø–æ–¥–º–µ—Ç–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã, —Ç–µ—Ö–Ω–∏–∫–∞ –¥–ª—è —É–±–æ—Ä–∫–∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π')
```

**SQL –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–π–ª: docs/migrations/fix-equipment-category.sql
```

---

### ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 2: –§–£–ù–ö–¶–ò–û–ù–ê–õ –ò –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨

#### 4. –°–æ–∑–¥–∞–Ω–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å /admin/categories
**–§–∞–π–ª—ã:**
- `frontend/app/admin/categories/page.tsx`
- `frontend/app/admin/categories/styles.css`

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ñ–æ—Ä–º–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π)
- ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (inline)
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω (mobile-friendly)
- ‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ö–∞–∫ –æ—Ç–∫—Ä—ã—Ç—å:**
```
http://localhost:3000/admin/categories
```

**–°–∫—Ä–∏–Ω—à–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏    [+ –î–æ–±–∞–≤–∏—Ç—å]     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üì¶ –ú–∏–Ω–∏-—Ç—Ä–∞–∫—Ç–æ—Ä—ã                           ‚îÇ
‚îÇ    /catalog/mini-tractors                  ‚îÇ
‚îÇ    [–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å] [–£–¥–∞–ª–∏—Ç—å]               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîß –ó–∞–ø—á–∞—Å—Ç–∏                                ‚îÇ
‚îÇ    /catalog/parts                          ‚îÇ
‚îÇ    [–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å] [–£–¥–∞–ª–∏—Ç—å]               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

#### 5. –î–æ–±–∞–≤–ª–µ–Ω–∞ Pagination –≤ API products
**–§–∞–π–ª:** `frontend/app/api/products/route.ts`

**–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```
GET /api/products?page=1&limit=20&category=1&search=—Ç—Ä–∞–∫—Ç–æ—Ä&sort=price_asc
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|----------|-----------------------|
| `page` | –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã | 1 |
| `limit` | –¢–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ | 20 (max: 100) |
| `category` | ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ | - |
| `search` | –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–æ–ø–∏—Å–∞–Ω–∏—é | - |
| `sort` | –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ | `newest` |

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:**
- `newest` - –Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ
- `price_asc` - –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Ü–µ–Ω—ã
- `price_desc` - –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Ü–µ–Ω—ã
- `name` - –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É

**–û—Ç–≤–µ—Ç API:**
```json
{
  "products": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "totalPages": 8,
    "hasNextPage": true,
    "hasPrevPage": false,
    "from": 1,
    "to": 20
  }
}
```

---

#### 6. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:**
```bash
GET /api/categories?search=—Ç—Ä–∞–∫—Ç–æ—Ä
# –í–µ—Ä–Ω—ë—Ç: "–ú–∏–Ω–∏-—Ç—Ä–∞–∫—Ç–æ—Ä—ã"
```

**–¢–æ–≤–∞—Ä—ã:**
```bash
GET /api/products?search=dongfeng
# –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ Case-insensitive (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π)
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é (`ilike %query%`)
- ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection)
- ‚úÖ –ü–æ–∏—Å–∫ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –ò –æ–ø–∏—Å–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞

---

### ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢ 3: –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ

#### 7. Bulk Import —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ CSV/JSON
**–§–∞–π–ª:** `frontend/app/api/import/products/route.ts`

**–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**
```
POST /api/import/products - –º–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç
GET  /api/import/products - –ø–æ–ª—É—á–∏—Ç—å —à–∞–±–ª–æ–Ω
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ò–º–ø–æ—Ä—Ç –¥–æ 1000 —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ —Ä–∞–∑
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞–ø–ø–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ø–æ slug)
- ‚úÖ Upsert –ª–æ–≥–∏–∫–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ slug)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```json
POST /api/import/products
{
  "products": [
    {
      "name": "DONGFENG DF-244",
      "slug": "dongfeng-df-244",
      "description": "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –º–∏–Ω–∏-—Ç—Ä–∞–∫—Ç–æ—Ä",
      "price": 450000,
      "old_price": 500000,
      "category_slug": "mini-tractors",
      "manufacturer": "DONGFENG",
      "model": "DF-244",
      "image_url": "https://...",
      "in_stock": true,
      "featured": true,
      "specifications": {
        "power": "24 –ª.—Å.",
        "engine": "–î–∏–∑–µ–ª—å–Ω—ã–π"
      }
    }
  ]
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "imported": 95,
  "failed": 5,
  "total": 100,
  "errors": [
    {
      "index": 12,
      "product": "–¢–æ–≤–∞—Ä X",
      "error": "Category not found: wrong-slug"
    }
  ]
}
```

---

#### 8. Audit Trail (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î)
**–§–∞–π–ª:** `docs/migrations/audit-trail.sql`

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:**
- ‚úÖ –í—Å–µ INSERT, UPDATE, DELETE –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö:
  - `categories`
  - `products`
  - `orders`
- ‚úÖ –°—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (JSONB)
- ‚úÖ –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
- ‚úÖ Timestamp –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `audit_log`:**
```sql
CREATE TABLE audit_log (
  id BIGSERIAL PRIMARY KEY,
  table_name TEXT NOT NULL,
  record_id BIGINT NOT NULL,
  action TEXT NOT NULL, -- 'INSERT', 'UPDATE', 'DELETE'
  old_data JSONB,
  new_data JSONB,
  changed_fields TEXT[],
  user_id UUID,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:**
```sql
-- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–∞ ID=1
SELECT * FROM get_audit_history('products', 1);

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ
SELECT * FROM get_recent_changes(100);

-- –í—Å–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü
SELECT * FROM audit_log
WHERE action = 'DELETE' 
  AND created_at > NOW() - INTERVAL '1 month';

-- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤
SELECT * FROM audit_log
WHERE table_name = 'products' 
  AND 'price' = ANY(changed_fields);
```

**–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:**
```sql
-- –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π
SELECT cleanup_old_audit_logs(90);
```

---

#### 9. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–°-–ë–∏—Ç—Ä–∏–∫—Å API
**–§–∞–π–ª:** `frontend/app/api/import/bitrix/route.ts`

**–î–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

##### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
```json
POST /api/import/bitrix
{
  "products": [
    {
      "NAME": "–¢–æ–≤–∞—Ä –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å",
      "CODE": "product-1",
      "PRICE": 100000,
      "DETAIL_TEXT": "–û–ø–∏—Å–∞–Ω–∏–µ",
      "SECTION_NAME": "–ú–∏–Ω–∏-—Ç—Ä–∞–∫—Ç–æ—Ä—ã",
      "PREVIEW_PICTURE": "https://..."
    }
  ]
}
```

##### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–∏—Ç—Ä–∏–∫—Å24 API
```json
POST /api/import/bitrix
{
  "bitrix_url": "https://–≤–∞—à-—Å–∞–π—Ç.bitrix24.ru",
  "webhook_code": "xxxxxxxxxxxxx",
  "user_id": "1"
}
```

**–ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π –ë–∏—Ç—Ä–∏–∫—Å ‚Üí Supabase:**
```
NAME            ‚Üí name
CODE            ‚Üí slug (–∏–ª–∏ auto-generated)
PRICE           ‚Üí price
DETAIL_TEXT     ‚Üí description
SECTION_NAME    ‚Üí category_id (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é)
PREVIEW_PICTURE ‚Üí image_url
AVAILABLE       ‚Üí in_stock
PROPERTIES      ‚Üí specifications (JSONB)
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è (—Ä—É—Å—Å–∫–∏–π ‚Üí –ª–∞—Ç–∏–Ω–∏—Ü–∞)
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è slug –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
- ‚úÖ –ú–∞–ø–ø–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ webhook –ë–∏—Ç—Ä–∏–∫—Å24
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ–± –∏–º–ø–æ—Ä—Ç–µ

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:**
```bash
# 1. –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
GET /api/import/bitrix

# 2. –°–æ–∑–¥–∞—Ç—å webhook –≤ –ë–∏—Ç—Ä–∏–∫—Å24
# https://–≤–∞—à-—Å–∞–π—Ç.bitrix24.ru/devops/webhook/
# –ü—Ä–∞–≤–∞: catalog

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç
POST /api/import/bitrix —Å –¥–∞–Ω–Ω—ã–º–∏ webhook
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã (11):
```
‚úÖ frontend/middleware.ts (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
‚úÖ frontend/app/api/categories/route.ts (—Ä–∞—Å—à–∏—Ä–µ–Ω)
‚úÖ frontend/app/api/categories/[id]/route.ts
‚úÖ frontend/app/api/products/route.ts (—Ä–∞—Å—à–∏—Ä–µ–Ω)
‚úÖ frontend/app/api/import/products/route.ts
‚úÖ frontend/app/api/import/bitrix/route.ts
‚úÖ frontend/app/admin/categories/page.tsx
‚úÖ frontend/app/admin/categories/styles.css
‚úÖ docs/migrations/fix-equipment-category.sql
‚úÖ docs/migrations/audit-trail.sql
‚úÖ IMPLEMENTATION_REPORT.md (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
```

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (2):
```
üìù docs/supabase-schema.sql (–æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è equipment)
üìù frontend/app/lib/validation.ts (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö API)
```

### –ù–æ–≤—ã–µ API endpoints (9):
```
GET    /api/categories          - —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
POST   /api/categories          - —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
GET    /api/categories/:id      - –ø–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
PUT    /api/categories/:id      - –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
DELETE /api/categories/:id      - —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
GET    /api/products            - —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (—Å pagination)
POST   /api/import/products     - –º–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç
GET    /api/import/bitrix       - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ë–∏—Ç—Ä–∏–∫—Å
POST   /api/import/bitrix       - –∏–º–ø–æ—Ä—Ç –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å
```

### –ù–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (1):
```
/admin/categories - –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### Build Status
```bash
‚úÖ npm run build - –£—Å–ø–µ—à–Ω–æ
‚úÖ TypeScript - –ë–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ Lint - –ü—Ä–æ–π–¥–µ–Ω
‚úÖ Middleware - –ê–∫—Ç–∏–≤–µ–Ω
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

#### 1. Rate Limiting
```bash
# –¢–µ—Å—Ç: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 101 –∑–∞–ø—Ä–æ—Å –∑–∞ –º–∏–Ω—É—Ç—É
for i in {1..101}; do curl http://localhost:3000/; done
# –û–∂–∏–¥–∞–µ—Ç—Å—è: 100 OK, 1 - 429 Too Many Requests
```

#### 2. CRUD –∫–∞—Ç–µ–≥–æ—Ä–∏–π
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ
curl -X POST http://localhost:3000/api/categories \
  -H "Content-Type: application/json" \
  -d '{"name":"–¢–µ—Å—Ç","slug":"test","description":"–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è"}'

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
curl -X PUT http://localhost:3000/api/categories/4 \
  -H "Content-Type: application/json" \
  -d '{"name":"–¢–µ—Å—Ç –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π"}'

# –£–¥–∞–ª–µ–Ω–∏–µ
curl -X DELETE http://localhost:3000/api/categories/4
```

#### 3. Pagination
```bash
# –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
curl "http://localhost:3000/api/products?page=1&limit=10"

# –ü–æ–∏—Å–∫ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
curl "http://localhost:3000/api/products?search=dongfeng&sort=price_asc"
```

#### 4. Bulk Import
```bash
curl -X POST http://localhost:3000/api/import/products \
  -H "Content-Type: application/json" \
  -d @products-export.json
```

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤ production:

#### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Supabase
```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ –ø–æ—Ä—è–¥–∫—É:
1. docs/migrations/fix-equipment-category.sql
2. docs/migrations/audit-trail.sql
```

#### 2. –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é equipment
```sql
UPDATE categories 
SET 
  name = '–ö–æ–º–º—É–Ω–∞–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞',
  description = '–°–Ω–µ–≥–æ—É–±–æ—Ä—â–∏–∫–∏, –≥–∞–∑–æ–Ω–æ–∫–æ—Å–∏–ª–∫–∏, –ø–æ–¥–º–µ—Ç–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã',
  updated_at = NOW()
WHERE slug = 'equipment';
```

#### 3. –î–µ–ø–ª–æ–π –Ω–∞ Netlify
```bash
git add .
git commit -m "‚ú® FEATURE: –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è API, –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, –∏–º–ø–æ—Ä—Ç–∞ –∏ –∞—É–¥–∏—Ç–∞"
git push origin main

# Netlify –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç
```

#### 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
```typescript
// frontend/app/admin/categories/page.tsx
// –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤:
// if (user.role !== 'admin') redirect('/');
```

#### 5. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis –¥–ª—è rate limiting
```bash
# –î–ª—è distributed rate limiting –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Upstash Redis
npm install @upstash/ratelimit @upstash/redis
```

---

## üìñ –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:
1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://–≤–∞—à-—Å–∞–π—Ç.com/admin/categories`
2. –ù–∞–∂–º–∏—Ç–µ **"+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é"**
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ:** –ü—Ä–∏—Ü–µ–ø—ã
   - **Slug:** `trailers` (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã)
   - **–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏—Ü–µ–ø—ã –¥–ª—è –º–∏–Ω–∏—Ç—Ä–∞–∫—Ç–æ—Ä–æ–≤
   - **URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:** `https://...`
4. –ù–∞–∂–º–∏—Ç–µ **"–°–æ–∑–¥–∞—Ç—å"**

### –ö–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ 1–°-–ë–∏—Ç—Ä–∏–∫—Å:
1. –ü–æ–ª—É—á–∏—Ç–µ webhook –∫–æ–¥ –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å24
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ POST –∑–∞–ø—Ä–æ—Å –Ω–∞ `/api/import/bitrix`:
```bash
curl -X POST http://–≤–∞—à-—Å–∞–π—Ç.com/api/import/bitrix \
  -H "Content-Type: application/json" \
  -d '{
    "bitrix_url": "https://–≤–∞—à-—Å–∞–π—Ç.bitrix24.ru",
    "webhook_code": "xxxxx",
    "user_id": "1"
  }'
```

### –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```sql
-- –í Supabase SQL Editor:
SELECT * FROM get_audit_history('products', 1);
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò

- [x] Rate limiting –≤–∫–ª—é—á—ë–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] API –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (CRUD) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Pagination –≤ API —Ç–æ–≤–∞—Ä–æ–≤
- [x] –ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
- [x] Bulk import —Ç–æ–≤–∞—Ä–æ–≤ (JSON)
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–°-–ë–∏—Ç—Ä–∏–∫—Å
- [x] Audit trail (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- [x] SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã
- [x] Build –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

---

## üéâ –ò–¢–û–ì

**–í—Å–µ 9 –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é!**

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫:
- ‚úÖ –î–µ–ø–ª–æ—é –≤ production
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —á–µ—Ä–µ–∑ UI
- ‚úÖ –ú–∞—Å—Å–æ–≤–æ–º—É –∏–º–ø–æ—Ä—Ç—É —Ç–æ–≤–∞—Ä–æ–≤
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
- ‚úÖ –ê—É–¥–∏—Ç—É –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ Netlify.

---

**–ê–≤—Ç–æ—Ä:** Claude (Anthropic)  
**–î–∞—Ç–∞:** 2025-11-11  
**–í–µ—Ä—Å–∏—è:** 2.0
