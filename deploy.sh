#!/bin/bash

# ============================================
# –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –î–ï–ü–õ–û–ô
# ============================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–ê–ß–ò–ù–ê–Æ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –î–ï–ü–õ–û–ô"
echo "=================================="
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ============================================
# –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# ============================================
echo "üìã –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

cd frontend

if [ ! -f ".env.local" ]; then
    echo -e "${RED}‚ùå –§–∞–π–ª .env.local –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª frontend/.env.local —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:"
    echo "  NEXT_PUBLIC_SUPABASE_URL=..."
    echo "  NEXT_PUBLIC_SUPABASE_ANON_KEY=..."
    exit 1
fi

echo -e "${GREEN}‚úÖ .env.local –Ω–∞–π–¥–µ–Ω${NC}"

# ============================================
# –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# ============================================
echo ""
echo "üì¶ –®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

if [ ! -d "node_modules" ]; then
    echo "–ó–∞–ø—É—Å–∫ npm install..."
    npm install
else
    echo -e "${GREEN}‚úÖ node_modules —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
fi

# ============================================
# –®–ê–ì 3: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
# ============================================
echo ""
echo "üî® –®–ê–ì 3: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."

npm run build

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Build —É—Å–ø–µ—à–µ–Ω!${NC}"
else
    echo -e "${RED}‚ùå Build –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è!${NC}"
    exit 1
fi

# ============================================
# –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ Netlify CLI
# ============================================
echo ""
echo "üåê –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ Netlify CLI..."

if ! command -v netlify &> /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Netlify CLI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
    echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    npm install -g netlify-cli
fi

echo -e "${GREEN}‚úÖ Netlify CLI –≥–æ—Ç–æ–≤${NC}"

# ============================================
# –®–ê–ì 5: –î–µ–ø–ª–æ–π –Ω–∞ Netlify
# ============================================
echo ""
echo "üöÄ –®–ê–ì 5: –î–µ–ø–ª–æ–π –Ω–∞ Netlify..."
echo -e "${YELLOW}–í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Netlify${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
netlify status 2>/dev/null || netlify login

# –î–µ–ø–ª–æ–π
echo ""
echo "–ó–∞–ø—É—Å–∫–∞—é production deploy..."
netlify deploy --prod --dir=.next

if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}‚úÖ‚úÖ‚úÖ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ï–ù! ‚úÖ‚úÖ‚úÖ${NC}"
else
    echo -e "${RED}‚ùå –î–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è${NC}"
    exit 1
fi

# ============================================
# –®–ê–ì 6: –§–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
# ============================================
echo ""
echo "=================================="
echo "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–Å–ù!"
echo "=================================="
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  –ù–ï –ó–ê–ë–£–î–¨–¢–ï:${NC}"
echo ""
echo "1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Supabase:"
echo "   - –û—Ç–∫—Ä–æ–π—Ç–µ https://supabase.com/dashboard"
echo "   - SQL Editor ‚Üí –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–∑ docs/migrations/"
echo ""
echo "2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (—Å–º. QUICK_DEPLOY.md)"
echo ""
echo "3. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Netlify:"
echo "   - NEXT_PUBLIC_SUPABASE_URL"
echo "   - NEXT_PUBLIC_SUPABASE_ANON_KEY"
echo ""
echo -e "${GREEN}–ì–æ—Ç–æ–≤–æ! –í–∞—à —Å–∞–π—Ç —Ç–µ–ø–µ—Ä—å –≤ production! üöÄ${NC}"
echo ""
